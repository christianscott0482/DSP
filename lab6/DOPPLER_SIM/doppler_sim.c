/*!
 * @file
 * @brief Generate a Doppler radar test signal 
 * @author Don Hummels
 * @date April 2018
 * 
 * 
 * Step through a fixed sequence of frequencies and amplitudes to simulate
 * changing targets.  N_TONES=4 separate tones are generated at various amplitudes.
 * Frequencies and amplitudes change every button press.
 * 
 * The sequence is hard-coded.  Four frequencies are generated, with amplitudes
 * that cycle through various "test cases". The active test case is displayed on
 * the LCD screen. (The frequencies remain fixed, but the amplitudes
 * are cycled to the next test case on each button press.)
 * 
 * Frequencies correspond to +41.38, +7.75, -12.93, and -38.79 meters/second, giving 
 *   F = 1600 Hz   300 Hz   -500 Hz  -1500 Hz. 
 * For a sample rate of 100 ksps, the frequencies are coded below as
 *   f = 16e-3, 3e-3, -5e-3, -15e-3  cycles/sample
 * 
 * @addtogroup ece486_fir
 */


#include "stm32l4xx_hal.h"
#include "stm32l476g_discovery.h"

#include "ece486.h"

#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include "arm_math.h"

extern FlagStatus KeyPressed;   // Use to detect button presses

#define N_TONES 4
#define N_CASES 7

#define FS FS_100K
#define NSAMP 1000

int main (void) {
  float input[NSAMP], output_re[NSAMP], output_im[NSAMP];
  
  static float f0[N_TONES] = { 16e-3, 3e-3, -5e-3, -15e-3 }; // Discrete-time frequencies
  static float ph[N_TONES] = { 0.3, 1.2, 5.3, 2.1 };         // Phase shifts
  
  // Test case amplitudes: Each row provides amplitudes for the various frequencies
  // To avoid saturation of the DAC, amplitudes for each case should sum < 0.7
  static float amp[N_CASES][N_TONES] = {
      { 0.1, 0.2, 0.3, 0.05 },  // Should give -38.79 m/s, +41.38 m/s
      { 0.0, 0.2, 0.2, 0.1 },   // Should give -38.79 m/s, +7.75 m/s
      { 0.1, 0.2, 0.2, 0.0 },   // Should give -12.93 m/s, +41.38 m/s
      { 0.0, 0.0, 0.0, 0.7 },   // Should give -38.79 m/s only
      { 0.0, 0.0, 0.7, 0.0 },   // Should give -12.93 m/s only
      { 0.0, 0.7, 0.0, 0.0 },   // Should give + 7.75 m/s only
      { 0.7, 0.0, 0.0, 0.0 }    // Should give +41.38 m/s only
  };
  
  // Small artificial DC offset (because it will be there... keep <=0.1)
  static float dc_offset_re = 0.1, dc_offset_im = -0.07;
  
  static int test_id=0; // Current Test case index
  char lcd_str[8];      // Used to display the test case on the LCD
  
  int i,j;	
  
  // This random array (which is actually periodic over the NSAMP Block-size)
  // provides some noise. To save a little memory, the same noise array is used for
  // both the real and imaginary outputs (but time-reversed over the block).
  
  static float sigma = 0.01; // Desired noise standard deviation (max noise approx 3*sigma)
  
  //static float sigma = 0.00; 
  //
  // "Random" noise array: NSAMP Gaussian values, standard deviation = 1
  // Generated in MATLAB: 
  // >> x = randn(1000,1);
  // >> fprintf(1,"\t%8.3e, %8.3e, %8.3e, %8.3e, %8.3e, %8.3e, %8.3e, %8.3e, %8.3e, %8.3e,\n",x)
  static float noise[NSAMP] = {
        5.377e-01, 1.834e+00, -2.259e+00, 8.622e-01, 3.188e-01, -1.308e+00, -4.336e-01, 3.426e-01, 3.578e+00, 2.769e+00,
	-1.350e+00, 3.035e+00, 7.254e-01, -6.305e-02, 7.147e-01, -2.050e-01, -1.241e-01, 1.490e+00, 1.409e+00, 1.417e+00,
	6.715e-01, -1.207e+00, 7.172e-01, 1.630e+00, 4.889e-01, 1.035e+00, 7.269e-01, -3.034e-01, 2.939e-01, -7.873e-01,
	8.884e-01, -1.147e+00, -1.069e+00, -8.095e-01, -2.944e+00, 1.438e+00, 3.252e-01, -7.549e-01, 1.370e+00, -1.712e+00,
	-1.022e-01, -2.414e-01, 3.192e-01, 3.129e-01, -8.649e-01, -3.005e-02, -1.649e-01, 6.277e-01, 1.093e+00, 1.109e+00,
	-8.637e-01, 7.736e-02, -1.214e+00, -1.114e+00, -6.849e-03, 1.533e+00, -7.697e-01, 3.714e-01, -2.256e-01, 1.117e+00,
	-1.089e+00, 3.256e-02, 5.525e-01, 1.101e+00, 1.544e+00, 8.593e-02, -1.492e+00, -7.423e-01, -1.062e+00, 2.350e+00,
	-6.156e-01, 7.481e-01, -1.924e-01, 8.886e-01, -7.648e-01, -1.402e+00, -1.422e+00, 4.882e-01, -1.774e-01, -1.961e-01,
	1.419e+00, 2.916e-01, 1.978e-01, 1.588e+00, -8.045e-01, 6.966e-01, 8.351e-01, -2.437e-01, 2.157e-01, -1.166e+00,
	-1.148e+00, 1.049e-01, 7.223e-01, 2.585e+00, -6.669e-01, 1.873e-01, -8.249e-02, -1.933e+00, -4.390e-01, -1.795e+00,
	8.404e-01, -8.880e-01, 1.001e-01, -5.445e-01, 3.035e-01, -6.003e-01, 4.900e-01, 7.394e-01, 1.712e+00, -1.941e-01,
	-2.138e+00, -8.396e-01, 1.355e+00, -1.072e+00, 9.610e-01, 1.240e-01, 1.437e+00, -1.961e+00, -1.977e-01, -1.208e+00,
	2.908e+00, 8.252e-01, 1.379e+00, -1.058e+00, -4.686e-01, -2.725e-01, 1.098e+00, -2.779e-01, 7.015e-01, -2.052e+00,
	-3.538e-01, -8.236e-01, -1.577e+00, 5.080e-01, 2.820e-01, 3.348e-02, -1.334e+00, 1.127e+00, 3.502e-01, -2.991e-01,
	2.289e-02, -2.620e-01, -1.750e+00, -2.857e-01, -8.314e-01, -9.792e-01, -1.156e+00, -5.336e-01, -2.003e+00, 9.642e-01,
	5.201e-01, -2.003e-02, -3.477e-02, -7.982e-01, 1.019e+00, -1.332e-01, -7.145e-01, 1.351e+00, -2.248e-01, -5.890e-01,
	-2.938e-01, -8.479e-01, -1.120e+00, 2.526e+00, 1.655e+00, 3.075e-01, -1.257e+00, -8.655e-01, -1.765e-01, 7.914e-01,
	-1.332e+00, -2.330e+00, -1.449e+00, 3.335e-01, 3.914e-01, 4.517e-01, -1.303e-01, 1.837e-01, -4.762e-01, 8.620e-01,
	-1.362e+00, 4.550e-01, -8.487e-01, -3.349e-01, 5.528e-01, 1.039e+00, -1.118e+00, 1.261e+00, 6.601e-01, -6.787e-02,
	-1.952e-01, -2.176e-01, -3.031e-01, 2.305e-02, 5.129e-02, 8.261e-01, 1.527e+00, 4.669e-01, -2.097e-01, 6.252e-01,
	1.832e-01, -1.030e+00, 9.492e-01, 3.071e-01, 1.352e-01, 5.152e-01, 2.614e-01, -9.415e-01, -1.623e-01, -1.461e-01,
	-5.320e-01, 1.682e+00, -8.757e-01, -4.838e-01, -7.120e-01, -1.174e+00, -1.922e-01, -2.741e-01, 1.530e+00, -2.490e-01,
	-1.064e+00, 1.603e+00, 1.235e+00, -2.296e-01, -1.506e+00, -4.446e-01, -1.559e-01, 2.761e-01, -2.612e-01, 4.434e-01,
	3.919e-01, -1.251e+00, -9.480e-01, -7.411e-01, -5.078e-01, -3.206e-01, 1.247e-02, -3.029e+00, -4.570e-01, 1.242e+00,
	-1.067e+00, 9.337e-01, 3.503e-01, -2.901e-02, 1.825e-01, -1.565e+00, -8.454e-02, 1.604e+00, 9.835e-02, 4.137e-02,
	-7.342e-01, -3.081e-02, 2.323e-01, 4.264e-01, -3.728e-01, -2.365e-01, 2.024e+00, -2.258e+00, 2.229e+00, 3.376e-01,
	1.000e+00, -1.664e+00, -5.900e-01, -2.781e-01, 4.227e-01, -1.670e+00, 4.716e-01, -1.213e+00, 6.619e-02, 6.524e-01,
	3.271e-01, 1.083e+00, 1.006e+00, -6.509e-01, 2.571e-01, -9.444e-01, -1.322e+00, 9.248e-01, 4.985e-05, -5.492e-02,
	9.111e-01, 5.946e-01, 3.502e-01, 1.250e+00, 9.298e-01, 2.398e-01, -6.904e-01, -6.516e-01, 1.192e+00, -1.612e+00,
	-2.446e-02, -1.949e+00, 1.020e+00, 8.617e-01, 1.162e-03, -7.084e-02, -2.486e+00, 5.812e-01, -2.192e+00, -2.319e+00,
	7.993e-02, -9.485e-01, 4.115e-01, 6.770e-01, 8.577e-01, -6.912e-01, 4.494e-01, 1.006e-01, 8.261e-01, 5.362e-01,
	8.979e-01, -1.319e-01, -1.472e-01, 1.008e+00, -2.124e+00, -5.046e-01, -1.271e+00, -3.826e-01, 6.487e-01, 8.257e-01,
	-1.015e+00, -4.711e-01, 1.370e-01, -2.919e-01, 3.018e-01, 3.999e-01, -9.300e-01, -1.768e-01, -2.132e+00, 1.145e+00,
	-6.291e-01, -1.204e+00, -2.539e-01, -1.429e+00, -2.086e-02, -5.607e-01, 2.178e+00, 1.138e+00, -2.497e+00, 4.413e-01,
	-1.398e+00, -2.551e-01, 1.644e-01, 7.477e-01, -2.730e-01, 1.576e+00, -4.809e-01, 3.275e-01, 6.647e-01, 8.519e-02,
	8.810e-01, 3.232e-01, -7.841e-01, -1.805e+00, 1.859e+00, -6.045e-01, 1.034e-01, 5.632e-01, 1.136e-01, -9.047e-01,
	-4.677e-01, -1.249e-01, 1.479e+00, -8.608e-01, 7.847e-01, 3.086e-01, -2.339e-01, -1.057e+00, -2.841e-01, -8.669e-02,
	-1.469e+00, 1.922e-01, -8.223e-01, -9.424e-02, 3.362e-01, -9.047e-01, -2.883e-01, 3.501e-01, -1.836e+00, 1.036e+00,
	2.424e+00, 9.594e-01, -3.158e-01, 4.286e-01, -1.036e+00, 1.878e+00, 9.407e-01, 7.873e-01, -8.759e-01, 3.199e-01,
	-5.583e-01, -3.114e-01, -5.700e-01, -1.026e+00, -9.087e-01, -2.099e-01, -1.699e+00, 6.076e-01, -1.178e-01, 6.992e-01,
	2.696e-01, 4.943e-01, -1.483e+00, -1.020e+00, -4.470e-01, 1.097e-01, 1.129e+00, -2.900e-01, 1.262e+00, 4.754e-01,
	1.174e+00, 1.269e-01, -6.568e-01, -1.481e+00, 1.555e-01, 8.186e-01, -2.926e-01, -5.408e-01, -3.086e-01, -1.097e+00,
	-4.930e-01, -1.807e-01, 4.584e-02, -6.378e-02, 6.113e-01, 1.093e-01, 1.814e+00, 3.120e-01, 1.804e+00, -7.231e-01,
	5.265e-01, -2.603e-01, 6.001e-01, 5.939e-01, -2.186e+00, -1.327e+00, -1.441e+00, 4.018e-01, 1.470e+00, -3.268e-01,
	8.123e-01, 5.455e-01, -1.052e+00, 3.975e-01, -7.519e-01, 1.516e+00, -3.257e-02, 1.636e+00, -4.251e-01, 5.894e-01,
	-6.279e-02, -2.022e+00, -9.821e-01, 6.125e-01, -5.489e-02, -1.119e+00, -6.264e-01, 2.495e-01, -9.930e-01, 9.750e-01,
	-6.407e-01, 1.809e+00, -1.080e+00, 1.992e-01, -1.521e+00, -7.236e-01, -5.933e-01, 4.013e-01, 9.421e-01, 3.005e-01,
	-3.731e-01, 8.155e-01, 7.989e-01, 1.202e-01, 5.712e-01, 4.128e-01, -9.870e-01, 7.596e-01, -6.572e-01, -6.039e-01,
	1.769e-01, -3.075e-01, -1.318e-01, 5.954e-01, 1.047e+00, -1.980e-01, 3.277e-01, -2.383e-01, 2.296e-01, 4.400e-01,
	-6.169e-01, 2.748e-01, 6.011e-01, 9.231e-02, 1.730e+00, -6.086e-01, -7.371e-01, -1.750e+00, 9.105e-01, 8.671e-01,
	-7.989e-02, 8.985e-01, 1.837e-01, 2.908e-01, 1.129e-01, 4.400e-01, 1.017e-01, 2.787e+00, -1.167e+00, -1.854e+00,
	-1.141e+00, -1.093e+00, -4.336e-01, -1.685e-01, -2.185e-01, 5.413e-01, 3.893e-01, 7.512e-01, 1.778e+00, 1.223e+00,
	-1.283e+00, -2.329e+00, 9.019e-01, -1.836e+00, 6.676e-02, 3.548e-02, 2.227e+00, -6.921e-02, -5.073e-01, 2.358e-01,
	2.458e-01, 7.005e-02, -6.086e-01, -1.223e+00, 3.165e-01, -1.343e+00, -1.032e+00, 1.331e+00, -4.189e-01, -1.403e-01,
	8.998e-01, -3.001e-01, 1.029e+00, -3.451e-01, 1.013e+00, 6.293e-01, -2.130e-01, -8.657e-01, -1.043e+00, -2.701e-01,
	-4.381e-01, -4.087e-01, 9.835e-01, -2.977e-01, 1.144e+00, -5.316e-01, 9.726e-01, -5.223e-01, 1.766e-01, 9.707e-01,
	-4.140e-01, -4.383e-01, 2.003e+00, 9.510e-01, -4.320e-01, 6.489e-01, -3.601e-01, 7.059e-01, 1.416e+00, -1.605e+00,
	1.029e+00, 1.458e+00, 4.747e-02, 1.746e+00, 1.554e-01, -1.237e+00, -2.193e+00, -3.334e-01, 7.135e-01, 3.174e-01,
	4.136e-01, -5.771e-01, 1.440e-01, -1.639e+00, -7.601e-01, -8.188e-01, 5.197e-01, -1.416e-02, -1.156e+00, -9.525e-03,
	-6.898e-01, -6.667e-01, 8.641e-01, 1.134e-01, 3.984e-01, 8.840e-01, 1.803e-01, 5.509e-01, 6.830e-01, 1.171e+00,
	4.759e-01, 1.412e+00, 2.261e-02, -4.787e-02, 1.701e+00, -5.097e-01, -2.855e-03, 9.199e-01, 1.498e-01, 1.405e+00,
	1.034e+00, 2.916e-01, -7.777e-01, 5.667e-01, -1.383e+00, 2.445e-01, 8.084e-01, 2.130e-01, 8.797e-01, 2.039e+00,
	9.239e-01, 2.669e-01, 6.417e-01, 4.255e-01, -1.315e+00, -4.164e-01, 1.225e+00, -4.358e-02, 5.824e-01, -1.007e+00,
	6.452e-02, 6.003e-01, -1.362e+00, 3.476e-01, -1.818e-01, -9.395e-01, -3.753e-02, -1.896e+00, -2.128e+00, -1.177e+00,
	-9.905e-01, -1.173e+00, -1.725e+00, 2.882e-01, -1.594e+00, 1.102e-01, 7.871e-01, -2.227e-03, 9.311e-02, -3.782e-01,
	-1.483e+00, -4.382e-02, 9.608e-01, 1.738e+00, -4.302e-01, -1.627e+00, 1.663e-01, 3.763e-01, -2.270e-01, -1.149e+00,
	2.024e+00, -2.360e+00, -5.100e-01, -1.322e+00, -6.361e-01, 3.179e-01, 1.380e-01, -7.107e-01, 7.770e-01, 6.224e-01,
	6.474e-01, -4.256e-01, 1.049e+00, 6.607e-01, 2.509e+00, 1.063e+00, 1.157e+00, 5.298e-02, -1.288e+00, -3.712e-01,
	-7.578e-01, -5.640e-01, 5.551e-01, -5.568e-01, -8.951e-01, -4.093e-01, -1.609e-01, 4.093e-01, -9.526e-01, 3.173e-01,
	7.802e-02, 1.324e+00, -2.132e-01, -1.345e-01, -1.171e+00, -1.385e+00, 3.105e-01, -2.495e-01, 5.037e-01, -8.927e-01,
	1.909e+00, 1.222e-01, 1.047e+00, -2.269e-01, -1.625e-01, 6.901e-01, 5.558e-01, -1.120e+00, -1.533e+00, -1.098e+00,
	-1.416e+00, 5.957e-02, -4.113e-01, -3.680e-01, -1.361e+00, 7.796e-01, 4.394e-01, -8.962e-02, 1.021e+00, -8.740e-01,
	4.147e-01, 3.484e-01, 3.493e-01, -7.292e-01, 3.268e-01, -5.149e-01, -8.964e-01, -1.203e+00, 1.038e+00, -8.459e-01,
	-1.729e-01, -1.209e+00, -2.971e-01, -3.232e+00, -1.087e+00, -1.426e+00, -1.014e+00, -2.133e-01, -3.253e-01, 1.944e+00,
	-5.718e-01, -2.500e-01, -1.569e+00, -4.774e-01, -1.338e+00, 3.030e-02, 8.531e-01, 4.043e-01, -7.006e-01, -1.631e+00,
	1.460e+00, 2.050e+00, 1.205e-01, -9.899e-01, 1.198e+00, -5.927e-01, -4.698e-01, 8.864e-01, -1.385e+00, -1.957e+00,
	4.207e-01, 4.007e-01, 9.514e-02, 4.967e-01, 1.082e+00, 9.704e-01, -5.686e-01, 8.100e-01, 1.732e-01, -5.055e-01,
	-1.193e+00, 6.470e-01, -3.536e-01, 4.643e-02, -7.929e-01, -1.551e+00, 1.716e-01, -6.214e-02, 1.199e+00, 8.017e-01,
	1.053e+00, -7.489e-01, -9.363e-01, -1.269e+00, 4.980e-01, 2.789e+00, 7.276e-01, -7.731e-01, 8.366e-01, -1.128e+00,
	-1.424e+00, 7.174e-01, -7.779e-01, 3.160e-01, 1.407e+00, 4.011e-01, 9.297e-01, -1.606e+00, 6.615e-01, 2.139e+00,
	5.411e-01, -1.541e+00, -2.031e-01, -5.000e-01, 3.830e-01, 4.120e-01, 4.055e-01, -3.638e-01, -5.993e-01, -5.896e-01,
	8.535e-01, -1.853e+00, -2.073e-01, 2.704e-01, -6.528e-01, 4.772e-01, -7.132e-02, -9.383e-01, 1.614e-01, -2.682e-01,
	-4.099e-01, -7.113e-01, 6.145e-02, -1.846e+00, -3.983e-01, -5.435e-01, -9.119e-01, 6.527e-01, -7.343e-01, 5.406e-01,
	9.758e-01, -1.569e-01, 2.778e-01, 6.395e-01, -8.098e-02, 5.409e-01, -1.263e+00, 1.110e+00, -9.896e-01, -1.829e+00,
	1.384e+00, -6.273e-02, 4.489e-01, -3.633e-01, -1.021e+00, -3.073e+00, 6.263e-01, -2.867e-01, -1.973e-01, 4.056e-01,
	-1.419e+00, -7.294e-01, 1.147e+00, 5.979e-01, -1.281e+00, -2.203e+00, -5.712e-01, 2.140e-01, 9.424e-01, 9.373e-02,
	-1.122e+00, 3.062e-01, -1.172e+00, -9.610e-01, -6.537e-01, -1.229e+00, -2.710e-01, -9.000e-01, -2.857e-01, -4.624e-01,
	-4.098e-01, -5.035e-01, 1.233e+00, 6.103e-01, 5.907e-02, -1.467e+00, -1.626e+00, -1.965e+00, 2.605e+00, 9.724e-01,
	2.570e-01, -9.742e-01, -1.146e+00, 5.476e-01, 1.565e+00, -1.693e+00, -4.494e-01, -8.429e-02, -1.992e+00, 8.412e-01,
	-4.147e-01, 1.912e+00, -3.909e-01, 4.092e-01, -1.142e+00, -6.249e-01, -1.169e+00, 3.926e-01, 1.302e+00, -5.936e-01,
	4.364e-01, -5.044e-01, 1.021e-01, 1.196e+00, 1.203e-01, -1.037e+00, -8.571e-01, -1.699e-01, -1.917e-01, -8.658e-01,
	1.807e-01, 1.267e+00, -2.512e-01, -2.046e-01, -2.202e+00, -7.745e-01, -1.393e+00, -3.862e-01, 5.256e-01, 1.523e+00,
	1.798e+00, -1.169e-01, -3.202e-01, 8.175e-01, 4.902e-01, 7.653e-01, 7.783e-01, -1.480e+00, 5.404e-01, -9.154e-02,
	-7.603e-01, -6.936e-01, 1.281e+00, -8.097e-01, -1.237e+00, 2.147e-01, 2.011e+00, 2.555e-02, 3.083e-01, -9.382e-01,
	1.674e+00, 1.250e-01, 5.301e-01, -9.521e-01, 8.540e-01, 3.891e-01, -1.156e+00, 3.974e-02, -4.506e-01, 1.092e-01,
	-2.506e-01, -1.899e-01, -1.033e+00, -3.233e-01, 7.665e-01, 1.745e+00, -1.161e+00, 2.377e+00, 1.526e+00, 1.685e-01,
	-3.012e-01, -6.987e-01, 8.328e-01, -6.946e-01, -4.619e-01, 8.836e-01, 4.359e-01, 8.967e-01, 5.047e-01, -4.009e-01,
	-5.138e-01, 7.964e-01, -6.712e-01, 1.187e+00, 7.907e-01, 2.877e-01, 3.226e-03, 3.656e-01, 3.527e+00, -1.124e-01,
	-1.557e+00, 1.915e+00, 6.098e-01, -6.479e-01, 2.617e+00, 5.510e-01, 2.942e-01, -7.778e-01, -1.065e+00, -1.768e+00,
	-4.229e-01, -1.053e+00, 6.478e-01, -3.176e-01, 1.769e+00, 1.511e+00, 1.640e-01, -2.828e-01, 1.152e+00, -1.147e+00
  };
  
  
  setblocksize( NSAMP );
  initialize_ece486(FS, MONO_IN, STEREO_OUT, HSE_EXTERNAL_8MHz);

  sprintf(lcd_str, "Test%2d", test_id);
  BSP_LCD_GLASS_DisplayString( (uint8_t *)lcd_str);
  for (i=0; i<NSAMP; i++) {
      output_re[i] = dc_offset_re + sigma*noise[i];
      output_im[i] = dc_offset_im + sigma*noise[NSAMP-1-i];
      for (j=0; j<N_TONES; j++) {
          output_re[i] += amp[test_id][j] * arm_cos_f32(2*M_PI*f0[j]*i+ph[j]);
          output_im[i] += amp[test_id][j] * arm_sin_f32(2*M_PI*f0[j]*i+ph[j]);
      }
  }
  

  while (1) {
    getblock(input);	//ask for a block of (unused) ADC samples
    
    if (KeyPressed) {           // Go to the next test case?
        KeyPressed = RESET;
        
        if (++test_id == N_CASES) test_id = 0;
        
        sprintf(lcd_str, "Test%2d", test_id);
        BSP_LCD_GLASS_DisplayString( (uint8_t *)lcd_str);
        for (i=0; i<NSAMP; i++) {
            output_re[i] = dc_offset_re + sigma*noise[i];
            output_im[i] = dc_offset_im + sigma*noise[NSAMP-1-i];
            for (j=0; j<N_TONES; j++) {
                output_re[i] += amp[test_id][j] * arm_cos_f32(2*M_PI*f0[j]*i + ph[j] );
                output_im[i] += amp[test_id][j] * arm_sin_f32(2*M_PI*f0[j]*i + ph[j] );
            }
        }
    }

    putblockstereo(output_re, output_im);
  }
  
  // Should never get here.

}


	
	


